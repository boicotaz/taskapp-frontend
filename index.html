<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task Management App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      color: #333;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #007BFF;
      color: white;
      padding: 20px;
      text-align: center;
    }

    main {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    button {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 5px;
    }

    button.secondary {
      background-color: #6c757d;
    }

    button:hover {
      opacity: 0.9;
    }

    .task {
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
      background-color: #fff;
    }

    .task strong {
      font-size: 1.1rem;
      color: #007BFF;
    }

    .task p {
      margin: 5px 0;
    }

    .task input,
    .task textarea,
    .task select {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

<header>
  <h1>Task Management App</h1>
</header>

<main>
  <button onclick="loadTasks()">Load Tasks</button>
  <h2>Create New Task</h2>
  <div class="task">
    <input type="text" id="new-title" placeholder="Title" />
    <textarea id="new-desc" placeholder="Description"></textarea>
    <select id="new-status">
      <option value="todo">todo</option>
      <option value="in_progress">in_progress</option>
      <option value="done">done</option>
    </select>
    <button onclick="createTask()">Create Task</button>
  </div>
  <hr />
  <div id="tasks"></div>
</main>

<script>
  let tasks = [];

  async function loadTasks() {
    const response = await fetch('/tasks');
    tasks = await response.json();
    renderTasks();
  }

  function renderTasks() {
    const container = document.getElementById('tasks');
    container.innerHTML = '';

    tasks.forEach(task => {
      container.appendChild(createTaskElement(task));
    });
  }

  function createTaskElement(task) {
    const div = document.createElement('div');
    div.className = 'task';

    div.innerHTML = `
      <div class="view-mode">
        <strong>${task.title}</strong>
        <p>${task.description}</p>
        <p>Status: ${task.status}</p>
        <button onclick="enterEditMode(${task.id})">Edit</button>
      </div>

      <div class="edit-mode" style="display:none;">
        <input type="text" value="${task.title}" id="title-${task.id}" />
        <textarea id="desc-${task.id}">${task.description}</textarea>
        <select id="status-${task.id}">
          <option value="todo">todo</option>
          <option value="in_progress">in_progress</option>
          <option value="done">done</option>
        </select>
        <button onclick="saveTask(${task.id})">Save</button>
        <button class="secondary" onclick="loadTasks()">Cancel</button>
      </div>
    `;

    div.querySelector(`#status-${task.id}`).value = task.status;

    return div;
  }

  function enterEditMode(taskId) {
    const taskDiv = [...document.getElementsByClassName('task')]
      .find(div => div.innerHTML.includes(`enterEditMode(${taskId})`));

    taskDiv.querySelector('.view-mode').style.display = 'none';
    taskDiv.querySelector('.edit-mode').style.display = 'block';
  }

  async function saveTask(taskId) {
    const title = document.getElementById(`title-${taskId}`).value;
    const description = document.getElementById(`desc-${taskId}`).value;
    const status = document.getElementById(`status-${taskId}`).value;

    const response = await fetch('/tasks', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: taskId,
        title,
        description,
        status
      })
    });

    if (!response.ok) {
      alert('Failed to update task');
      return;
    }

    loadTasks();
  }
  
  async function createTask() {
    const title = document.getElementById('new-title').value;
    const description = document.getElementById('new-desc').value;
    const status = document.getElementById('new-status').value;

    if (!title) {
      alert('Title is required');
      return;
    }

    const response = await fetch('/tasks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        title,
        description,
        status
      })
    });

    if (!response.ok) {
      alert('Failed to create task');
      return;
    }

    // Reset form
    document.getElementById('new-title').value = '';
    document.getElementById('new-desc').value = '';
    document.getElementById('new-status').value = 'todo';

    loadTasks();
  }
</script>

</body>
</html>